<!-- Modern Events Component with NgRx -->
<div class="px-8 py-6 bg-background-light font-heading">
  <!-- Header Section with Search -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
    <div class="mb-4 md:mb-0">
      <h1 class="text-2xl font-bold text-primary-700">Eventos e Atividades</h1>
      <p class="text-neutral-600 mt-1">Participe de eventos para praticar seu inglês</p>
    </div>

    <!-- Search Bar -->
    <div class="relative w-full md:w-64">
      <input
        type="text"
        placeholder="Pesquisar eventos..."
        [(ngModel)]="searchQuery"
        class="w-full pl-10 pr-4 py-2 bg-white border border-neutral-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"
      >
      <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
    </div>
  </div>

  <!-- Custom Tab Menu -->
  <div class="bg-white rounded-xl shadow-md mb-6 overflow-hidden">
    <div class="flex border-b border-neutral-200">
      <button
        (click)="setTab('all')"
        [ngClass]="{
          'bg-primary-50 text-primary-700 border-b-4 border-primary-600': activeTab === 'all',
          'text-neutral-600 hover:bg-neutral-50': activeTab !== 'all'
        }"
        class="flex-1 px-6 py-4 font-semibold text-sm transition-all focus:outline-none"
      >
        <i class="pi pi-th-large mr-2"></i>
        Todos os eventos
      </button>
      <button
        (click)="setTab('my-events')"
        [ngClass]="{
          'bg-primary-50 text-primary-700 border-b-4 border-primary-600': activeTab === 'my-events',
          'text-neutral-600 hover:bg-neutral-50': activeTab !== 'my-events'
        }"
        class="flex-1 px-6 py-4 font-semibold text-sm transition-all focus:outline-none"
      >
        <i class="pi pi-user mr-2"></i>
        Meus Eventos
      </button>
      <button
        (click)="setTab('upcoming')"
        [ngClass]="{
          'bg-primary-50 text-primary-700 border-b-4 border-primary-600': activeTab === 'upcoming',
          'text-neutral-600 hover:bg-neutral-50': activeTab !== 'upcoming'
        }"
        class="flex-1 px-6 py-4 font-semibold text-sm transition-all focus:outline-none"
      >
        <i class="pi pi-calendar-plus mr-2"></i>
        Próximos eventos
      </button>
      <button
        (click)="setTab('past')"
        [ngClass]="{
          'bg-primary-50 text-primary-700 border-b-4 border-primary-600': activeTab === 'past',
          'text-neutral-600 hover:bg-neutral-50': activeTab !== 'past'
        }"
        class="flex-1 px-6 py-4 font-semibold text-sm transition-all focus:outline-none"
      >
        <i class="pi pi-history mr-2"></i>
        Eventos passados
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="bg-white rounded-xl p-4 shadow-md mb-8">
    <div class="flex flex-wrap gap-3">
      <div
        (click)="setFilter('all')"
        [ngClass]="activeFilter === 'all' ? 'bg-primary-50 text-primary-700' : 'bg-neutral-50 text-neutral-700'"
        class="px-3 py-1.5 rounded-lg font-medium text-sm flex items-center hover:bg-primary-100 transition-all cursor-pointer"
      >
        <span>Todos</span>
      </div>
      <div
        (click)="setFilter(EventType.WORKSHOP)"
        [ngClass]="activeFilter === EventType.WORKSHOP ? 'bg-primary-50 text-primary-700' : 'bg-neutral-50 text-neutral-700'"
        class="px-3 py-1.5 rounded-lg font-medium text-sm flex items-center hover:bg-primary-100 transition-all cursor-pointer"
      >
        <i class="pi pi-briefcase mr-2"></i>
        <span>Workshops</span>
      </div>
      <div
        (click)="setFilter(EventType.SEMINAR)"
        [ngClass]="activeFilter === EventType.SEMINAR ? 'bg-primary-50 text-primary-700' : 'bg-neutral-50 text-neutral-700'"
        class="px-3 py-1.5 rounded-lg font-medium text-sm flex items-center hover:bg-primary-100 transition-all cursor-pointer"
      >
        <i class="pi pi-comments mr-2"></i>
        <span>Seminários</span>
      </div>
      <div
        (click)="setFilter(EventType.TALK)"
        [ngClass]="activeFilter === EventType.TALK ? 'bg-primary-50 text-primary-700' : 'bg-neutral-50 text-neutral-700'"
        class="px-3 py-1.5 rounded-lg font-medium text-sm flex items-center hover:bg-primary-100 transition-all cursor-pointer"
      >
        <i class="pi pi-book mr-2"></i>
        <span>Palestras</span>
      </div>
      <div
        (click)="setFilter(EventType.MEETING)"
        [ngClass]="activeFilter === EventType.MEETING ? 'bg-primary-50 text-primary-700' : 'bg-neutral-50 text-neutral-700'"
        class="px-3 py-1.5 rounded-lg font-medium text-sm flex items-center hover:bg-primary-100 transition-all cursor-pointer"
      >
        <i class="pi pi-users mr-2"></i>
        <span>Encontros</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <app-loader [loading]="loading$" [label]="'Carregando eventos...'"></app-loader>

  <!-- Error State -->
  <div *ngIf="(error$ | ngrxPush) && !(loading$ | ngrxPush)" class="bg-white rounded-2xl shadow-sm p-8 mb-8">
    <div class="flex flex-col items-center text-center">
      <div class="rounded-full bg-error-100 p-4 mb-4">
        <i class="pi pi-exclamation-triangle text-error-500 text-3xl"></i>
      </div>
      <h3 class="text-xl font-bold text-neutral-800 mb-2">Erro ao carregar eventos</h3>
      <p class="text-neutral-600 mb-4">{{ error$ | ngrxPush }}</p>
      <button
        (click)="retry()"
        class="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all font-semibold shadow-md"
      >
        Tentar novamente
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="(getFilteredEvents$() | ngrxPush)?.length === 0 && !(loading$ | ngrxPush) && !(error$ | ngrxPush)"
       class="bg-white rounded-2xl shadow-sm p-12 text-center">
    <div class="rounded-full bg-neutral-100 w-24 h-24 flex items-center justify-center mx-auto mb-6">
      <i class="pi pi-calendar text-neutral-400 text-5xl"></i>
    </div>
    
    <!-- Empty state for "Meus Eventos" tab -->
    <div *ngIf="activeTab === 'my-events'">
      <h3 class="text-xl font-bold text-neutral-800 mb-2">Você ainda não está inscrito em nenhum evento</h3>
      <p class="text-neutral-600 max-w-md mx-auto mb-4">
        Explore os eventos disponíveis e inscreva-se para começar a participar!
      </p>
      <button
        (click)="setTab('all')"
        class="mt-4 px-6 py-3 bg-primary-500 text-white rounded-lg font-medium hover:bg-primary-600 transition-all"
      >
        Ver Todos os Eventos
      </button>
    </div>
    
    <!-- Empty state for other tabs -->
    <div *ngIf="activeTab !== 'my-events'">
      <h3 class="text-xl font-bold text-neutral-800 mb-2">Nenhum evento encontrado</h3>
      <p class="text-neutral-600 max-w-md mx-auto">
        <span *ngIf="activeTab === 'upcoming'">Não há eventos futuros disponíveis no momento.</span>
        <span *ngIf="activeTab === 'past'">Não há eventos passados.</span>
        <span *ngIf="activeTab === 'all'">Não há eventos disponíveis no momento. Volte mais tarde para ver novos eventos.</span>
      </p>
    </div>
  </div>

  <!-- Events Grid -->
  <div *ngIf="(getFilteredEvents$() | ngrxPush)?.length"
       class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Event Card -->
    <div
      *ngFor="let event of getFilteredEvents$() | ngrxPush"
      class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300"
    >
      <!-- Event Header with Gradient Background -->
      <div class="relative h-32 bg-gradient-to-r"
           [ngClass]="'from-' + getEventColor(event.type) + '-600 to-' + getEventColor(event.type) + '-500'">
        <div class="absolute inset-0 bg-[url('/bg_st.png')] bg-cover bg-center opacity-20"></div>

        <!-- Event Type Badge -->
        <div class="absolute top-3 right-3 bg-white bg-opacity-20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-medium text-white">
          {{ getEventTypeLabel(event.type) }}
        </div>

        <!-- Online/Location Badge -->
        <div class="absolute top-3 left-3 bg-white bg-opacity-20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-medium text-white flex items-center">
          <i [ngClass]="event.online ? 'pi pi-globe' : 'pi pi-map-marker'" class="mr-1"></i>
          <span>{{ event.online ? 'Online' : 'Presencial' }}</span>
        </div>

        <!-- Event Date -->
        <div class="absolute bottom-3 left-3 bg-white bg-opacity-20 backdrop-blur-sm px-3 py-2 rounded-lg text-white">
          <div class="flex items-center text-sm">
            <i class="pi pi-calendar mr-2"></i>
            <span>{{ formatDate(event.startAt) }}</span>
          </div>
        </div>
      </div>

      <!-- Event Content -->
      <div class="p-4">
        <h2 class="text-lg font-bold text-neutral-800 mb-2">{{ event.title }}</h2>

        <!-- Event Details -->
        <div class="space-y-2 mb-4">
          <div class="flex items-center text-sm text-neutral-600">
            <i class="pi pi-clock mr-2 text-neutral-400"></i>
            <span>{{ formatTime(event.startAt) }}</span>
          </div>
          <div class="flex items-center text-sm text-neutral-600">
            <i [ngClass]="event.online ? 'pi pi-video' : 'pi pi-map-marker'" class="mr-2 text-neutral-400"></i>
            <span class="truncate">{{ event.online ? 'Online' : event.location || 'A definir' }}</span>
          </div>
          <div class="flex items-center text-sm text-neutral-600">
            <i class="pi pi-users mr-2 text-neutral-400"></i>
            <span>{{ getParticipantCount(event) }}/{{ event.maxCapacity }} participantes</span>
          </div>
        </div>

        <p class="text-neutral-600 text-sm mb-4 line-clamp-2">
          {{ event.description }}
        </p>

        <!-- Registration Status -->
        <div *ngIf="student$ | ngrxPush as student" class="mb-3">
          <div *ngIf="isRegistered(event, student.id)"
               class="flex items-center bg-success-50 text-success-700 px-3 py-2 rounded-lg text-sm">
            <i class="pi pi-check-circle mr-2"></i>
            <span>Você está inscrito</span>
          </div>
          <div *ngIf="!isRegistered(event, student.id) && !hasCapacity(event)"
               class="flex items-center bg-error-50 text-error-700 px-3 py-2 rounded-lg text-sm">
            <i class="pi pi-times-circle mr-2"></i>
            <span>Lotado</span>
          </div>
        </div>
      </div>

      <!-- Event Actions -->
      <div class="px-4 py-3 bg-neutral-50 border-t border-neutral-200 flex gap-2">
        <button
          (click)="openEventDetails(event)"
          class="flex-1 py-2 rounded-lg text-primary-700 border border-primary-700 font-medium hover:bg-primary-50 transition-all flex items-center justify-center text-sm"
        >
          <i class="pi pi-info-circle mr-1"></i>
          Detalhes
        </button>
        <button
          *ngIf="student$ | ngrxPush as student"
          (click)="isRegistered(event, student.id) ? cancelRegistration(event.id, event.title) : registerForEvent(event.id, event.title)"
          [disabled]="!isRegistered(event, student.id) && !hasCapacity(event)"
          [ngClass]="{
            'bg-error-500 hover:bg-error-600': isRegistered(event, student.id),
            'bg-primary-500 hover:bg-primary-600': !isRegistered(event, student.id) && hasCapacity(event),
            'bg-neutral-300 cursor-not-allowed': !isRegistered(event, student.id) && !hasCapacity(event)
          }"
          class="flex-1 py-2 rounded-lg text-white font-medium transition-all flex items-center justify-center text-sm"
        >
          <i [ngClass]="isRegistered(event, student.id) ? 'pi pi-times' : 'pi pi-plus'" class="mr-1"></i>
          {{ isRegistered(event, student.id) ? 'Cancelar' : 'Inscrever' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Infinite Scroll Sentinel -->
  <div #scrollSentinel class="py-8"></div>

  <!-- Loading More Indicator -->
  <div *ngIf="loading$ | ngrxPush" class="flex justify-center items-center py-8">
    <div class="flex flex-col items-center gap-3">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary-500"></div>
      <p class="text-neutral-600 text-sm">Carregando mais eventos...</p>
    </div>
  </div>

  <!-- End of Results -->
  <div *ngIf="!(loading$ | ngrxPush) && (currentPage$ | ngrxPush) as currentPage" class="text-center py-6">
    <div *ngIf="(totalPages$ | ngrxPush) as totalPages">
      <div *ngIf="currentPage + 1 >= totalPages && totalPages > 0" class="bg-neutral-100 rounded-lg px-6 py-4 inline-block">
        <div class="flex items-center gap-2 text-neutral-600">
          <i class="pi pi-check-circle text-success-500"></i>
          <span class="text-sm font-medium">
            Todos os eventos carregados ({{ totalElements$ | ngrxPush }} no total)
          </span>
        </div>
      </div>

      <!-- Scroll to Top Button -->
      <button
        *ngIf="currentPage > 0"
        (click)="scrollToTop()"
        class="mt-4 px-6 py-3 bg-white border border-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-all flex items-center gap-2 mx-auto"
      >
        <i class="pi pi-arrow-up"></i>
        <span>Voltar ao topo</span>
      </button>
    </div>
  </div>
</div>

<!-- Event Details Modal (Simple version - can be enhanced) -->
<div *ngIf="showEventDetails() && selectedEvent"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
     (click)="closeEventDetails()">
  <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
    <div class="sticky top-0 bg-white border-b border-neutral-200 px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-bold text-neutral-800">Detalhes do Evento</h2>
      <button (click)="closeEventDetails()" class="text-neutral-400 hover:text-neutral-600">
        <i class="pi pi-times text-xl"></i>
      </button>
    </div>

    <div class="p-6">
      <h3 class="text-2xl font-bold text-neutral-800 mb-4">{{ selectedEvent.title }}</h3>

      <div class="space-y-4 mb-6">
        <div class="flex items-start">
          <i class="pi pi-calendar text-primary-600 mr-3 mt-1"></i>
          <div>
            <p class="text-sm text-neutral-600">Data e Hora</p>
            <p class="font-semibold text-neutral-800">
              {{ formatDate(selectedEvent.startAt) }} às {{ formatTime(selectedEvent.startAt) }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <i [ngClass]="selectedEvent.online ? 'pi pi-video' : 'pi pi-map-marker'" class="text-primary-600 mr-3 mt-1"></i>
          <div>
            <p class="text-sm text-neutral-600">{{ selectedEvent.online ? 'Link Online' : 'Local' }}</p>
            <p class="font-semibold text-neutral-800">
              {{ selectedEvent.online ? (selectedEvent.onlineLink || 'Link será enviado') : (selectedEvent.location || 'A definir') }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <i class="pi pi-users text-primary-600 mr-3 mt-1"></i>
          <div>
            <p class="text-sm text-neutral-600">Participantes</p>
            <p class="font-semibold text-neutral-800">
              {{ getParticipantCount(selectedEvent) }}/{{ selectedEvent.maxCapacity }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <i class="pi pi-tag text-primary-600 mr-3 mt-1"></i>
          <div>
            <p class="text-sm text-neutral-600">Tipo</p>
            <p class="font-semibold text-neutral-800">{{ getEventTypeLabel(selectedEvent.type) }}</p>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h4 class="font-bold text-neutral-800 mb-2">Descrição</h4>
        <p class="text-neutral-600 leading-relaxed">{{ selectedEvent.description }}</p>
      </div>

      <div *ngIf="student$ | ngrxPush as student" class="flex gap-3">
        <button
          (click)="closeEventDetails()"
          class="flex-1 py-3 rounded-lg border border-neutral-200 text-neutral-700 font-medium hover:bg-neutral-50 transition-all"
        >
          Fechar
        </button>
        <button
          (click)="isRegistered(selectedEvent, student.id) ? cancelRegistration(selectedEvent.id, selectedEvent.title) : registerForEvent(selectedEvent.id, selectedEvent.title); closeEventDetails()"
          [disabled]="!isRegistered(selectedEvent, student.id) && !hasCapacity(selectedEvent)"
          [ngClass]="{
            'bg-error-500 hover:bg-error-600': isRegistered(selectedEvent, student.id),
            'bg-primary-500 hover:bg-primary-600': !isRegistered(selectedEvent, student.id) && hasCapacity(selectedEvent),
            'bg-neutral-300 cursor-not-allowed': !isRegistered(selectedEvent, student.id) && !hasCapacity(selectedEvent)
          }"
          class="flex-1 py-3 rounded-lg text-white font-medium transition-all"
        >
          {{ isRegistered(selectedEvent, student.id) ? 'Cancelar Inscrição' : 'Inscrever-se' }}
        </button>
      </div>
    </div>
  </div>
</div>
