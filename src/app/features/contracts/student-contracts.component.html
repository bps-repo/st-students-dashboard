<div class="p-2 sm:p-4 md:p-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
    <h1
      class="text-2xl md:text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-primary-700 to-accent-700">
      Financeiro &amp; Contratos</h1>
    <div class="flex items-center gap-2">
      <label class="text-sm text-neutral-700 hidden sm:block">Contrato:</label>
      <select class="px-3 py-1.5 bg-white/80 border border-neutral-200 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
              [ngModel]="selectedContractId()"
              (ngModelChange)="selectedContractId.set($event)"
              [ngModelOptions]="{standalone: true}">
        <option value="ALL">Todos</option>
        <option *ngFor="let c of contracts()" [value]="c.id">{{ c.contractType }} • {{ c.status }} ({{ c.startDate | date:'dd/MM' }} - {{ c.endDate | date:'dd/MM' }})</option>
      </select>
      <button (click)="load()"
              class="px-3 py-1 bg-gradient-to-r from-secondary-600 to-secondary-700 text-white rounded-lg hover:from-primary-700 hover:to-primary-800 text-sm shadow"
              title="Recarregar">
        <i class="pi pi-refresh"></i>
      </button>
    </div>
  </div>

  <div *ngIf="loading()" class="p-6 bg-white/70 backdrop-blur rounded-xl shadow">A carregar...</div>
  <div *ngIf="error()" class="p-4 bg-red-50 text-red-700 rounded-xl shadow">{{ error() }}</div>
  <div *ngIf="!loading() && !error() && (!contracts() || contracts()?.length === 0)"
       class="p-6 bg-white/70 backdrop-blur rounded-xl shadow">Nenhum contrato encontrado.
  </div>

  <div *ngIf="contracts()?.length" class="space-y-6">
    <div *ngFor="let c of filteredContracts()" class="bg-white/80 backdrop-blur rounded-2xl shadow border border-white/60">
      <!-- Contract header -->
      <div class="p-5 border-b border-neutral-100 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wide text-neutral-500">Contrato</div>
          <div class="text-lg font-semibold text-neutral-900">{{ c.contractType }} • {{ c.status }}</div>
        </div>
        <div class="text-left sm:text-right">
          <div class="text-xs uppercase tracking-wide text-neutral-500">Período</div>
          <div class="font-medium">{{ c.startDate | date:'dd/MM/yyyy' }} - {{ c.endDate | date:'dd/MM/yyyy' }}</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="p-5 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="p-4 rounded-xl border border-primary-100 bg-gradient-to-br from-primary-50 to-white">
          <div class="text-xs text-primary-700">Valor Total</div>
          <div class="text-xl font-bold text-primary-800">{{ toCurrency(c.amount) }}</div>
        </div>
        <div class="p-4 rounded-xl border border-accent-100 bg-gradient-to-br from-accent-50 to-white">
          <div class="text-xs text-accent-700">Desconto</div>
          <div class="text-xl font-bold text-accent-800">{{ c.discountPercent }}%</div>
        </div>
        <div class="p-4 rounded-xl border border-secondary-100 bg-gradient-to-br from-secondary-50 to-white">
          <div class="text-xs text-secondary-700">Parcelas</div>
          <div class="text-xl font-bold text-secondary-800">{{ c.installments?.length || 0 }}</div>
        </div>
      </div>

      <!-- Installments progress bar -->
      <div class="px-5 pb-2">
        <div class="flex items-center justify-between mb-1">
          <div class="text-sm font-semibold text-neutral-800">Progresso das parcelas</div>
          <div class="text-xs text-neutral-600">{{ getPaidCount(c) }}/{{ c.installments?.length || 0 }} pagas ({{ getProgressPercent(c) }}%)</div>
        </div>
        <div class="w-full bg-neutral-200/70 rounded-full h-2.5" role="progressbar" [attr.aria-valuenow]="getProgressPercent(c)" aria-valuemin="0" aria-valuemax="100" [attr.aria-label]="'Progresso das parcelas: ' + getProgressPercent(c) + '%'">
          <div class="h-2.5 rounded-full bg-gradient-to-r from-green-500 to-green-600" [ngStyle]="{ width: getProgressPercent(c) + '%' }"></div>
        </div>
        <div class="mt-1 text-[11px] text-neutral-600">
          <span class="mr-3"><span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Pagas: {{ getPaidCount(c) }}</span>
          <span class="mr-3"><span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-1"></span>Pendentes: {{ getPendingCount(c) }}</span>
          <span><span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-1"></span>Em atraso: {{ getOverdueCount(c) }}</span>
        </div>
      </div>

      <!-- Levels table -->
      <div class="p-5">
        <div class="text-sm font-semibold mb-2">Níveis</div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left bg-neutral-50/80">
            <tr>
              <th class="p-2">Ordem</th>
              <th class="p-2">Nível</th>
              <th class="p-2">Duração</th>
              <th class="p-2">Preço Nível</th>
              <th class="p-2">Material</th>
              <th class="p-2">Inclui Material</th>
              <th class="p-2">Status</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let l of c.levels" class="border-t hover:bg-neutral-50/60">
              <td class="p-2">{{ l.levelOrder || '-' }}</td>
              <td class="p-2">{{ l.name || '-' }}</td>
              <td class="p-2">{{ l.duration || '-' }} meses</td>
              <td class="p-2">{{ toCurrency(l.finalLevelPrice ?? l.levelPrice) }}</td>
              <td class="p-2">{{ toCurrency(l.finalCourseMaterialPrice ?? l.courseMaterialPrice) }}</td>
              <td class="p-2"><span class="px-2 py-0.5 rounded-full text-xs"
                                    [ngClass]="l.includeCourseMaterial ? 'bg-green-100 text-green-700' : 'bg-neutral-100 text-neutral-700'">{{ l.includeCourseMaterial ? 'Sim' : 'Não' }}</span>
              </td>
              <td class="p-2">{{ l.status || '-' }}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Installments -->
      <div class="p-5 border-t border-neutral-100">
        <div class="text-sm font-semibold mb-2">Parcelas</div>
        <div class="grid md:grid-cols-3 gap-3">
          <div *ngFor="let i of c.installments" class="border rounded-xl p-4 shadow-sm" [ngClass]="{
              'border-red-200 bg-red-50/80': isOverdue(i.dueDate, i.status),
              'border-yellow-200 bg-yellow-50/80': !isOverdue(i.dueDate, i.status) && i.status !== 'PAID',
              'border-green-200 bg-green-50/80': i.status === 'PAID'
            }">
            <div class="flex items-center justify-between">
              <div class="font-medium">Parcela {{ i.installmentNumber }}</div>
              <span class="text-xs px-2 py-0.5 rounded-full"
                    [ngClass]="{
                  'bg-red-200 text-red-800': isOverdue(i.dueDate, i.status),
                  'bg-yellow-200 text-yellow-800': !isOverdue(i.dueDate, i.status) && i.status !== 'PAID',
                  'bg-green-200 text-green-800': i.status === 'PAID'
                }">
                {{ isOverdue(i.dueDate, i.status) ? 'Em Atraso' : (i.status === 'PAID' ? 'Pago' : 'Pendente') }}
              </span>
            </div>
            <div class="text-sm text-neutral-600">Vencimento: {{ i.dueDate | date:'dd/MM/yyyy' }}</div>
            <div class="text-lg font-bold">{{ toCurrency(i.amount) }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="c.notes" class="p-5 border-t text-sm text-neutral-700">Notas: {{ c.notes }}</div>
    </div>
  </div>
</div>
