<div class="p-3 sm:p-4 md:p-6">
  <div class="flex flex-col gap-3 sm:gap-4 mb-4 sm:mb-6">
    <h1
      class="text-xl sm:text-2xl md:text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-primary-700 to-accent-700">
      Financeiro &amp; Contratos</h1>
    <div class="flex flex-col xs:flex-row items-stretch xs:items-center gap-2">
      <label class="text-xs sm:text-sm text-neutral-700 hidden xs:block">Contrato:</label>
      <select class="px-3 py-2 sm:py-1.5 bg-white/80 border border-neutral-200 rounded-lg shadow-sm text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 flex-1"
              [ngModel]="selectedContractId()"
              (ngModelChange)="selectedContractId.set($event)"
              [ngModelOptions]="{standalone: true}">
        <option value="ALL">Todos</option>
        <option *ngFor="let c of contracts()" [value]="c.id">{{ c.contractType }} • {{ c.status }} ({{ c.startDate | date:'dd/MM' }} - {{ c.endDate | date:'dd/MM' }})</option>
      </select>
      <button (click)="load()"
              class="px-3 py-2 sm:py-1 bg-gradient-to-r from-secondary-600 to-secondary-700 text-white rounded-lg hover:from-primary-700 hover:to-primary-800 text-xs sm:text-sm shadow flex items-center justify-center"
              title="Recarregar">
        <i class="pi pi-refresh text-xs sm:text-sm"></i>
      </button>
    </div>
  </div>

  <div *ngIf="loading()" class="p-4 sm:p-6 bg-white/70 backdrop-blur rounded-lg sm:rounded-xl shadow text-sm sm:text-base">A carregar...</div>
  <div *ngIf="error()" class="p-4 bg-red-50 text-red-700 rounded-lg sm:rounded-xl shadow text-sm sm:text-base">{{ error() }}</div>
  <div *ngIf="!loading() && !error() && (!contracts() || contracts()?.length === 0)"
       class="p-4 sm:p-6 bg-white/70 backdrop-blur rounded-lg sm:rounded-xl shadow text-sm sm:text-base">Nenhum contrato encontrado.
  </div>

  <div *ngIf="contracts()?.length" class="space-y-4 sm:space-y-6">
    <div *ngFor="let c of filteredContracts()" class="bg-white/80 backdrop-blur rounded-lg sm:rounded-2xl shadow border border-white/60">
      <!-- Contract header -->
      <div class="p-4 sm:p-5 border-b border-neutral-100 flex flex-col gap-3">
        <div>
          <div class="text-[10px] sm:text-xs uppercase tracking-wide text-neutral-500">Contrato</div>
          <div class="text-base sm:text-lg font-semibold text-neutral-900">{{ c.contractType }} • {{ c.status }}</div>
        </div>
        <div>
          <div class="text-[10px] sm:text-xs uppercase tracking-wide text-neutral-500">Período</div>
          <div class="font-medium text-sm sm:text-base">{{ c.startDate | date:'dd/MM/yyyy' }} - {{ c.endDate | date:'dd/MM/yyyy' }}</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="p-4 sm:p-5 grid grid-cols-1 xs:grid-cols-3 gap-3 sm:gap-4">
        <div class="p-3 sm:p-4 rounded-lg sm:rounded-xl border border-primary-100 bg-gradient-to-br from-primary-50 to-white">
          <div class="text-[10px] sm:text-xs text-primary-700">Valor Total</div>
          <div class="text-lg sm:text-xl font-bold text-primary-800 truncate">{{ toCurrency(c.amount) }}</div>
        </div>
        <div class="p-3 sm:p-4 rounded-lg sm:rounded-xl border border-accent-100 bg-gradient-to-br from-accent-50 to-white">
          <div class="text-[10px] sm:text-xs text-accent-700">Desconto</div>
          <div class="text-lg sm:text-xl font-bold text-accent-800">{{ c.discountPercent }}%</div>
        </div>
        <div class="p-3 sm:p-4 rounded-lg sm:rounded-xl border border-secondary-100 bg-gradient-to-br from-secondary-50 to-white">
          <div class="text-[10px] sm:text-xs text-secondary-700">Parcelas</div>
          <div class="text-lg sm:text-xl font-bold text-secondary-800">{{ c.installments?.length || 0 }}</div>
        </div>
      </div>

      <!-- Installments progress bar -->
      <div class="px-4 sm:px-5 pb-2">
        <div class="flex flex-col xs:flex-row xs:items-center xs:justify-between gap-1 xs:gap-0 mb-1.5 sm:mb-1">
          <div class="text-xs sm:text-sm font-semibold text-neutral-800">Progresso das parcelas</div>
          <div class="text-[10px] sm:text-xs text-neutral-600">{{ getPaidCount(c) }}/{{ c.installments?.length || 0 }} pagas ({{ getProgressPercent(c) }}%)</div>
        </div>
        <div class="w-full bg-neutral-200/70 rounded-full h-2 sm:h-2.5" role="progressbar" [attr.aria-valuenow]="getProgressPercent(c)" aria-valuemin="0" aria-valuemax="100" [attr.aria-label]="'Progresso das parcelas: ' + getProgressPercent(c) + '%'">
          <div class="h-2 sm:h-2.5 rounded-full bg-gradient-to-r from-green-500 to-green-600" [ngStyle]="{ width: getProgressPercent(c) + '%' }"></div>
        </div>
        <div class="mt-1.5 sm:mt-1 text-[10px] sm:text-[11px] text-neutral-600 flex flex-wrap gap-2 sm:gap-3">
          <span class="flex items-center"><span class="inline-block w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-green-500 mr-1"></span>Pagas: {{ getPaidCount(c) }}</span>
          <span class="flex items-center"><span class="inline-block w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-yellow-400 mr-1"></span>Pendentes: {{ getPendingCount(c) }}</span>
          <span class="flex items-center"><span class="inline-block w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-red-500 mr-1"></span>Em atraso: {{ getOverdueCount(c) }}</span>
        </div>
      </div>

      <!-- Levels table -->
      <div class="p-4 sm:p-5">
        <div class="text-xs sm:text-sm font-semibold mb-2">Níveis</div>
        <div class="overflow-x-auto -mx-4 sm:mx-0">
          <div class="inline-block min-w-full px-4 sm:px-0">
            <table class="min-w-full text-xs sm:text-sm">
              <thead class="text-left bg-neutral-50/80">
              <tr>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Ordem</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Nível</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Duração</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Preço Nível</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Material</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Inclui Material</th>
                <th class="p-1.5 sm:p-2 whitespace-nowrap">Status</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let l of c.levels" class="border-t hover:bg-neutral-50/60">
                <td class="p-1.5 sm:p-2">{{ l.levelOrder || '-' }}</td>
                <td class="p-1.5 sm:p-2">{{ l.name || '-' }}</td>
                <td class="p-1.5 sm:p-2 whitespace-nowrap">{{ l.duration || '-' }} meses</td>
                <td class="p-1.5 sm:p-2 whitespace-nowrap">{{ toCurrency(l.finalLevelPrice ?? l.levelPrice) }}</td>
                <td class="p-1.5 sm:p-2 whitespace-nowrap">{{ toCurrency(l.finalCourseMaterialPrice ?? l.courseMaterialPrice) }}</td>
                <td class="p-1.5 sm:p-2"><span class="px-1.5 sm:px-2 py-0.5 rounded-full text-[10px] sm:text-xs"
                                      [ngClass]="l.includeCourseMaterial ? 'bg-green-100 text-green-700' : 'bg-neutral-100 text-neutral-700'">{{ l.includeCourseMaterial ? 'Sim' : 'Não' }}</span>
                </td>
                <td class="p-1.5 sm:p-2">{{ l.status || '-' }}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Installments -->
      <div class="p-4 sm:p-5 border-t border-neutral-100">
        <div class="text-xs sm:text-sm font-semibold mb-2 sm:mb-3">Parcelas</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
          <div *ngFor="let i of c.installments" class="border rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-sm" [ngClass]="{
              'border-red-200 bg-red-50/80': isOverdue(i.dueDate, i.status),
              'border-yellow-200 bg-yellow-50/80': !isOverdue(i.dueDate, i.status) && i.status !== 'PAID',
              'border-green-200 bg-green-50/80': i.status === 'PAID'
            }">
            <div class="flex items-center justify-between mb-1.5 sm:mb-2">
              <div class="font-medium text-sm sm:text-base">Parcela {{ i.installmentNumber }}</div>
              <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full"
                    [ngClass]="{
                  'bg-red-200 text-red-800': isOverdue(i.dueDate, i.status),
                  'bg-yellow-200 text-yellow-800': !isOverdue(i.dueDate, i.status) && i.status !== 'PAID',
                  'bg-green-200 text-green-800': i.status === 'PAID'
                }">
                {{ isOverdue(i.dueDate, i.status) ? 'Em Atraso' : (i.status === 'PAID' ? 'Pago' : 'Pendente') }}
              </span>
            </div>
            <div class="text-xs sm:text-sm text-neutral-600 mb-1">Vencimento: {{ i.dueDate | date:'dd/MM/yyyy' }}</div>
            <div class="text-base sm:text-lg font-bold truncate">{{ toCurrency(i.amount) }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="c.notes" class="p-4 sm:p-5 border-t text-xs sm:text-sm text-neutral-700">Notas: {{ c.notes }}</div>
    </div>
  </div>
</div>
